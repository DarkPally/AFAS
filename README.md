# AFAS

# 取证规则编辑器说明文档 (180306)

## 概述与工具使用流程

目前，每个规则是一个互相独立的json格式文本，按照一定规则填写对应的项目，取证工具便能正确地解析该规则，并对设定的工作目录进行单应用的取证分析。

当前版本功能还比较简陋，接下来会进行大更新，目前版本正确使用流程如下：

1. 在 **规则编辑** 页面下，点击 **加载规则** 按钮，工具会自动读取RuleLibrary目录下的有效规则
2. 在 **规则包名** 右侧的下拉列表中选择待编辑的规则，之后下方的文本框会显示规则的文本内容。
3. 对规则进行编辑，完成后点击 **测试当前规则** 按钮
   1. 如果结果返回 “测试成功！”，则说明规则没有语法上的问题；反之，报错则说明json格式语法或类型上存在错误，鼠标悬停在 状态文字 上方会显示具体的异常信息。
   2. 如果需要运行测试，即使没有更改规则文本，也需要点击此按钮；只有点击此按钮，工具才会把工作的规则切换为当前规则。
4. 测试完成后，在上方正常配置工作路径，点击 **文件夹解析** 即可进行单例测试。
5. 无论何时，只要没有点击 **保存当前规则** 按钮，规则都不会保存，所以要及时点击。
6. 目前尚未支持新建规则，新增规则时可直接在RuleLibrary目录下复制一个txt文档并重命名。



## 规则语法说明

规则为json格式文本，下面将介绍每个节点的属性。

需要注意的是，并不是每个属性都要写在规则上，如果不明文写出某个属性，那么该属性就会以默认值出现。默认值包括（0、false、null）等。

### 根节点

根节点的属性固定，属性名称和作用如下表所示：

属性名称 | 说明与作用
------------ | -------------
Name | 规则包的正规名称，应准确填写包名。为做区分IOS的规则后跟(IOS)
Version | 版本信息，目前没用，用于后续做版本区分
Desc | 规则包的描述名称，显示在选择列表和取证结果中的名称
Items | 规则条目的集合，这是一个json数组类型，里面按序记载了一系列具体的规则，详见 **规则节点说明** 条目
Scripts | 脚本集合，同样是json数组。考虑到有些脚本要经常复用，因此可把需要复用的脚本放在此处管理，详见 **脚本使用说明** 条目
RootPathPrepares | 用特征文件匹配法获取根路径的集合，直接用路径/正则路径法可无视此属性，详见 **文件捕获规则说明** 条目

### 规则节点说明

目前有六种类型的规则，由"$type"属性控制具体的规则类型，使用时只需作为枚举量粘贴到相应位置即可，列表如下：

规则类型 | 对应的$type属性的值
------------ | -------------
文件捕获 | "AFAS.Library.FileCatchInfo, AFAS.Library"
文件处理 | "AFAS.Library.FileProcessInfo, AFAS.Library"
数据捕获 | "AFAS.Library.DataCatchInfo, AFAS.Library"
数据处理 | "AFAS.Library.DataProcessInfo, AFAS.Library"
数据关联 | "AFAS.Library.DataAssociateInfo, AFAS.Library"
结果标记 | "AFAS.Library.DataMarkInfo, AFAS.Library"

#### 文件捕获规则

文件捕获规则的作用为，根据本规则的描述捕获某一个，或某一类文件，并将捕获的文件信息存放到数据表中。本规则涉及到的属性如下：

属性名称 | 作用说明
------------ | -------------
Key | 输出数据表的索引键，在后续操作中可使用该Key访问到数据表
RootPathType| 根目录类型，填写“Default”或不填时以RootPath为固定路径；填“PathPrepare”时，RootPath由特征文件匹配获得。
RootPath | 在直接使用路径/正则匹配时，目标文件的根目录。可不填该项，默认值为data/data/[包名]/；在特征文件匹配时，RootPath为根节点下RootPathPrepares内对应的索引
RelativePath | 目标文件的相对路径
IsRegEx | 目标文件的相对路径是否包含正则

根节点下的RootPathPrepares内可包含一个或多个元素，如：

```json
 "RootPathPrepares":[
   {
       "Name":"root",
       "PathRegexes":
       [
           "_store_(.*)/messenger_contacts.v1/fbomnistore.db$",
       ]
   }
```
PathRegexes下存放一个或多个正则，只要某目录下的所有正则都能匹配，就认为是一个有效的根目录，并且以Name作为索引。

#### 文件处理规则

如果捕获到的文件是经过特殊编码、加密的，可在此步进行处理，目前暂时用不到，略去。

#### 数据捕获规则

在文件已经捕获、处理后，本规则的作用是指导工具如何从文件提取数据，属性列表如下：
属性名称 | 作用说明
------------ | -------------
Key | 输入索引，一般为文件捕获规则中的Key值，作为源文件的索引
TableKey | 输出索引，即数据捕获完毕后，输出的数据表的索引
DataPath | 数据路径，里面存储的内容由Type属性指定
Type| 捕获类型，目前有五种类型：<br>“Binary”:二进制处理法，DataPath存储脚本文本<br>“Text”:文本文件处理法，DataPath存储可提取文本的正则<br>“Xml”:处理Xml，将xml转化为数据库格式，DataPath为转化后的表名<br>“Database”：处理数据库，DataPath为数据表名<br>“DatabaseWithRegEx”：处理数据库，但DataPath为数据表名的正则
Select | 如果需要对捕获到的结果进行筛选，可填写此属性，填写方法参考DataTable.Select()函数的语法。
CatchToFileDataTree| bool值，默认为false,true时将把本表结果作为文件表的子表，属于数据关联的内容。

#### 数据处理规则

#### 数据关联规则

#### 结果标记规则
